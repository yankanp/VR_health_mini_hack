<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>VR Gemini Triggered Screenshot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  </head>

  <body>
    <a-scene background="color:#101418" webxr="optionalFeatures: local-floor">
      <a-entity light="type:ambient;intensity:0.6"></a-entity>
      <a-entity light="type:directional;intensity:1" position="1 3 2"></a-entity>

      <a-plane rotation="-90 0 0" width="20" height="20" color="#333"></a-plane>

      <a-entity id="rig" movement-controls position="0 1.6 0">
        <a-entity camera look-controls>
          <a-entity id="geminiCard" position="0.4 -0.2 -1.5" visible="true">
            <a-plane width="1.5" height="0.5" color="#222" opacity="0.6"></a-plane>
            <a-text id="geminiText"
                    value="Press trigger to analyze view"
                    align="center" wrap-count="35"
                    position="0 0 0.01" width="1.3" color="#FFF"></a-text>
          </a-entity>
        </a-entity>

        <!-- Right controller -->
        <a-entity id="rightHand" oculus-touch-controls="hand: right" trigger-capture></a-entity>
      </a-entity>

      <a-assets>
        <a-asset-item id="muscle" src="models/muscle.glb"></a-asset-item>
      </a-assets>
      <a-entity gltf-model="#muscle" position="0 2 -2" scale="80 80 80"></a-entity>

      <script>
        const textEl = document.getElementById("geminiText");
        const host = window.location.hostname;
        const ws = new WebSocket("wss://" + host + ":8001");

        ws.onopen = () => {
          console.log("✅ Connected to Gemini WebSocket");
          textEl.setAttribute("value", "Connected. Press trigger to analyze.");
        };

        ws.onmessage = (event) => {
          const msg = event.data;
          textEl.setAttribute("value", msg);
          console.log("🤖 Gemini:", msg);
        };

        ws.onerror = (err) => {
          console.error("WebSocket error:", err);
          textEl.setAttribute("value", "⚠️ WebSocket error");
        };

        // Register trigger-capture component
        AFRAME.registerComponent("trigger-capture", {
          init: function () {
            this.el.addEventListener("triggerdown", () => {
              console.log("🎮 Trigger pressed — sending 'capture'");
              textEl.setAttribute("value", "Capturing...");
              ws.send("capture");
            });
          },
        });
      </script>
    </a-scene>
  </body>
</html>
