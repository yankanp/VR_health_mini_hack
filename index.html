<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Gemini VR Scene (Improved HUD)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <style>body { margin: 0; background: #000; }</style>
  </head>

  <body>
    <a-scene background="color: #101418" webxr="optionalFeatures: local-floor">
      <!-- 💡 Lighting -->
      <a-entity light="type: ambient; intensity: 0.8"></a-entity>
      <a-entity light="type: directional; intensity: 1.2" position="2 4 3"></a-entity>

      <!-- 🪨 Ground -->
      <a-plane rotation="-90 0 0" width="30" height="30" color="#222" shadow="receive: true"></a-plane>

      <!-- 👤 Player Rig -->
      <a-entity id="rig" movement-controls="speed: 0.25" position="0 1.6 0">
        <a-entity camera look-controls>
          <!-- ✨ Gemini Card (bottom-right HUD style) -->
          <a-entity id="geminiCard"
                    position="0.6 -0.4 -1.2"
                    visible="true"
                    scale="0.7 0.7 0.7">
            <a-plane width="1.4" height="0.45"
                     color="#0a0a0a"
                     opacity="0.75"
                     material="shader: flat"
                     shadow="cast: true; receive: true">
            </a-plane>

            <!-- Subtle border glow -->
            <a-ring radius-inner="0.71" radius-outer="0.73" position="0 0 0.01"
                    material="color: #00c6ff; emissive: #00c6ff; emissiveIntensity: 0.3; shader: flat">
            </a-ring>

            <!-- Header -->
            <a-text value="Gemini"
                    position="0 0.17 0.02"
                    align="center"
                    width="1.3"
                    color="#00c6ff"
                    font="mozillavr">
            </a-text>

            <!-- Response text -->
            <a-text id="geminiText"
                    value="Press trigger to analyze"
                    align="center"
                    wrap-count="40"
                    position="0 -0.05 0.02"
                    width="1.3"
                    color="#fff"
                    font="mozillavr">
            </a-text>
          </a-entity>
        </a-entity>

        <!-- 🎮 Right Controller -->
        <a-entity id="rightHand"
                  oculus-touch-controls="hand: right"
                  raycaster="objects: .interactable"
                  line="color: yellow; opacity: 0.8"
                  cursor
                  trigger-capture>
        </a-entity>

        <!-- 🖐️ Left Controller -->
        <a-entity id="leftHand" oculus-touch-controls="hand: left"></a-entity>
      </a-entity>

      <!-- 🧠 Assets -->
      <a-assets>
        <a-asset-item id="muscle" src="models/muscle.glb"></a-asset-item>
        <a-asset-item id="room" src="models/room.glb"></a-asset-item>
        <a-asset-item id="heart" src="models/heart.glb"></a-asset-item>
      </a-assets>

      <!-- 🏠 Room Environment -->
      <a-entity gltf-model="#room" position="0 0 0" scale="1 1 1"
                class="environment" shadow="receive: true"></a-entity>

      <!-- 🦴 Skeleton Model -->
      <a-entity gltf-model="#muscle" position="0 3 -1.5" scale="100 100 100"
                class="interactable" shadow="cast: true"></a-entity>

      <!-- ❤️ Heart Model -->
      <a-entity gltf-model="#heart" position="1.2 1 -2.5" rotation="0 -20 0"
                scale="0.25 0.25 0.25" class="interactable" shadow="cast: true"></a-entity>

      <!-- 🔧 Script -->
      <script>
        const textEl = document.getElementById("geminiText");
        const host = window.location.hostname;
        const ws = new WebSocket("wss://" + host + ":8001");

        ws.onopen = () => {
          console.log("✅ Connected to Gemini WebSocket");
          textEl.setAttribute("value", "Connected. Press trigger to analyze.");
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            const msg = data.text || event.data || "(no text)";
            textEl.setAttribute("value", msg);
            console.log("🤖 Gemini:", msg);
            if (data.audio) {
              const audio = new Audio("data:audio/mp3;base64," + data.audio);
              audio.play().catch(err => console.warn("Audio play error:", err));
            }
          } catch {
            textEl.setAttribute("value", event.data);
          }
        };

        ws.onerror = (err) => {
          console.error("WebSocket error:", err);
          textEl.setAttribute("value", "⚠️ WebSocket error");
        };

        // 🎮 Trigger Capture
        AFRAME.registerComponent("trigger-capture", {
          init: function () {
            this.el.addEventListener("triggerdown", () => {
              console.log("🎮 Trigger pressed — sending 'capture'");
              textEl.setAttribute("value", "Capturing...");
              ws.send("capture");
            });
          },
        });
      </script>
    </a-scene>
  </body>
</html>
